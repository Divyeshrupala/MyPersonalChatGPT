<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Divyesh's GPT</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      height: 100vh;
      display: flex;
      background: #f4f4f4;
    }
    #sidebar {
      width: 250px;
      background: #222;
      color: white;
      padding: 10px;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }
    #sidebar h2 {
      text-align: center;
      margin-top: 0;
    }
    .history-item {
      padding: 8px;
      margin: 4px 0;
      background: #333;
      border-radius: 6px;
      cursor: pointer;
    }
    .history-item:hover { background: #444; }
    #main {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      padding: 20px;
    }
    #appTitle {
      font-size: 1.8em;
      font-weight: bold;
      margin-bottom: 15px;
      color: #333;
      text-align: center;
    }
    #chatContainer {
      background: white;
      width: 100%;
      max-width: 700px;
      height: 500px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    #chatBox {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      background: #fafafa;
      white-space: pre-wrap;
    }
    .msg {
      margin: 6px 0;
      padding: 8px 12px;
      border-radius: 10px;
      max-width: 80%;
    }
    .user { background: #d0ebff; align-self: flex-end; }
    .bot { background: #e6ffe6; align-self: flex-start; }
    #controls {
      display: flex;
      padding: 10px;
      border-top: 1px solid #ddd;
      background: #f0f0f0;
    }
    #userInput {
      flex: 1;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    button {
      padding: 10px 14px;
      margin-left: 8px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    #voiceBtn.off { background: #007bff; color: white; }
    #voiceBtn.on { background: #dc3545; color: white; }
  </style>
</head>
<body>
  <div id="sidebar">
    <h2>History</h2>
    <div id="history"></div>
  </div>

  <div id="main">
    <div id="appTitle">Divyesh's GPT</div>
    <div id="chatContainer">
      <div id="chatBox"></div>
      <div id="controls">
        <input id="userInput" type="text" placeholder="Type your message...">
        <button id="sendBtn">Send</button>
        <button id="voiceBtn" class="off">Voice: Off</button>
        <button id="clearBtn">Clear</button>
        <input type="file" id="fileInput" style="display:none;">
        <button id="uploadBtn">Attach File</button>
      </div>
    </div>
  </div>

  <script>
    const chatBox = document.getElementById("chatBox");
    const input = document.getElementById("userInput");
    const sendBtn = document.getElementById("sendBtn");
    const clearBtn = document.getElementById("clearBtn");
    const historyDiv = document.getElementById("history");
    const voiceBtn = document.getElementById("voiceBtn");
    const fileInput = document.getElementById("fileInput");
    const uploadBtn = document.getElementById("uploadBtn");

    let currentChat = [];
    let isLoadedHistory = false;
    let recognition;
    let isListening = false;
    let attachedFile = null;

    function addMessage(text, sender) {
      const div = document.createElement("div");
      div.className = "msg " + sender;
      div.textContent = text;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
      currentChat.push({ sender, text });
    }

    async function sendMessage(msg) {
      if (!msg.trim() && !attachedFile) return;

      addMessage("You: " + (msg || attachedFile.name), "user");
      input.value = "";

      const typingDiv = document.createElement("div");
      typingDiv.className = "msg bot";
      typingDiv.textContent = "GPT is typing...";
      chatBox.appendChild(typingDiv);
      chatBox.scrollTop = chatBox.scrollHeight;

      try {
        let res;
        if (attachedFile) {
          const formData = new FormData();
          formData.append("file", attachedFile);
          formData.append("message", msg);
          res = await fetch("/api/upload", {
            method: "POST",
            body: formData
          });
        } else {
          res = await fetch("/api/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ messages: [{ role: "user", content: msg }] })
          });
        }

        const data = await res.json();
        typingDiv.remove();

        if (data.summary) {
          addMessage("GPT: " + data.summary, "bot");
        } else {
          addMessage("GPT: " + (data.reply || "(No reply from GPT)"), "bot");
        }
      } catch (err) {
        typingDiv.remove();
        addMessage("GPT: (Error contacting GPT)", "bot");
        console.error(err);
      } finally {
        attachedFile = null;
        document.getElementById("attachments")?.remove();
      }
    }

    sendBtn.onclick = () => sendMessage(input.value);
    input.addEventListener("keypress", e => { if (e.key === "Enter") sendMessage(input.value); });

    // Attach file (but don't send immediately)
    uploadBtn.onclick = () => fileInput.click();

    fileInput.onchange = e => {
      const file = e.target.files[0];
      if (!file) return;
      attachedFile = file;
      let attachDiv = document.getElementById("attachments");
      if (!attachDiv) {
        attachDiv = document.createElement("div");
        attachDiv.id = "attachments";
        chatBox.appendChild(attachDiv);
      }
      attachDiv.textContent = `ðŸ“Ž Attached: ${file.name}`;
      chatBox.scrollTop = chatBox.scrollHeight;
      fileInput.value = "";
    };

    // ðŸŽ¤ Voice on/off
  if ("webkitSpeechRecognition" in window) {
    recognition = new webkitSpeechRecognition();
    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.lang = "en-US";

    recognition.onresult = (event) => {
      const transcript = event.results[0][0].transcript;
      input.value = transcript;
      sendMessage(transcript);
    };

    recognition.onerror = (event) => {
      console.error("Voice recognition error:", event.error);
      stopListening();
    };

    recognition.onend = () => {
      if (isListening) recognition.start(); // auto-restart while ON
    };
  } else {
    voiceBtn.disabled = true;
    voiceBtn.textContent = "Voice not supported";
  }

  function startListening() {
    if (recognition && !isListening) {
      recognition.start();
      isListening = true;
      voiceBtn.classList.remove("off");
      voiceBtn.classList.add("on");
      voiceBtn.textContent = "Voice: On";
    }
  }

  function stopListening() {
    if (recognition && isListening) {
      recognition.stop();
      isListening = false;
      voiceBtn.classList.remove("on");
      voiceBtn.classList.add("off");
      voiceBtn.textContent = "Voice: Off";
    }
  }

  voiceBtn.addEventListener("click", () => {
    if (isListening) stopListening();
    else startListening();
  });

  // Clear button
  clearBtn.onclick = () => {
    chatBox.innerHTML = "";
    currentChat = [];
  };
  </script>
</body>
</html>
